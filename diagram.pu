@startuml

!theme plain
hide empty members
skinparam linetype ortho
skinparam nodesep 60
skinparam ranksep 60

title "Mox System Architecture: Full Blueprint"

' ==========================================
' 1. SHARED DOMAIN (Bahasa Bersama)
' ==========================================
package "pkg/moxproto (Shared)" {
    enum MsgType {
        HANDSHAKE
        FD_TRANSFER
        HEARTBEAT
        SHUTDOWN
        ACK
    }

    class MoxMessage {
        + ID: string
        + Type: MsgType
        + FromPID: int
        + Payload: json.RawMessage
        + Timestamp: int64
    }
}

' ==========================================
' 2. CORE INTERFACES (Kontrak / Abstraksi)
' ==========================================
package "Core Interfaces" {

    ' --- Master Side Contracts ---
    interface "WorkerRegistrar" as IRegistrar {
        + Add(worker: Worker)
        + Remove(pid: int)
    }

    interface "WorkerProvider" as IProvider {
        + Get(pid: int): Worker
        + GetAll(): []Worker
        + Total(): int
    }

    interface "Messaging" as IMessaging {
        + Send(ctx, pid, msg)
        + Broadcast(ctx, topic, msg)
        + Request(ctx, pid, topic, msg): Response
    }

    ' --- Worker Side Contracts ---
    interface "UserApplication" as IUserApp {
        + Serve(listener: net.Listener)
        + Shutdown(ctx)
    }
}

' ==========================================
' 3. MASTER PROCESS (Server Side)
' ==========================================
package "Master Process" {

    ' --- Infrastructure Layer ---
    package "Infra" {
        class "ConnectionRegistry" as Registry {
            - workers: map[int]*Worker
            - mu: sync.RWMutex

            -- Implements --
            + Add(w)
            + Remove(pid)
            + Get(pid)
            + StartCleanupLoop()
        }

        class "IPCServer" as Server {
            - socketPath: string
            - registrar: IRegistrar

            -- Logic --
            + ListenAndServe()
            - handleHandshake(conn)
            - sendFD(conn, fd)
        }

        class "EventBus" as Bus {
            - provider: IProvider

            -- Logic --
            + Send(pid, msg)
            + Broadcast(msg)
        }
    }

    ' --- Domain Layer ---
    package "Domain" {
        class "Orchestrator" as Brain {
            - bus: IMessaging
            - provider: IProvider

            -- Logic --
            + StartLoop()
            + CheckHealth()
            + ScaleUp()
            + ScaleDown()
        }
    }

    ' --- Composition Root ---
    class "Master" as App {
        ' Master Holds Everything
        - registry: *ConnectionRegistry
        - server: *IPCServer
        - bus: *EventBus
        - orchestrator: *Orchestrator
        - ctx: context.Context

        + NewMaster()
        + Run()
        + Stop()
    }
}

' ==========================================
' 4. WORKER PROCESS (Client Side)
' ==========================================
package "Worker Process" {

    class "IPCClient" as Client {
        - conn: *net.UnixConn
        - socketPath: string

        + Connect()
        + ReceiveFD(): int
        + Send(msg: MoxMessage)
        + ListenLoop()
    }

    class "MoxAgent" as Agent {
        - app: IUserApp
        - client: *IPCClient
        - pid: int

        + Start()
        + Register()
        - heartbeatLoop()
    }

    class "BusinessLogic" as UserCode {
        + Serve(ln)
    }


' --- THE MISSING PIECE ADDED HERE ---
        class "Worker" as WorkerEntity {
            ' Ini representasi Worker di mata Master
            - pid: int
            - state: WorkerState
            - conn: *net.UnixConn
            - lastSeen: time.Time

            -- Logic --
            + Write(msg: MoxMessage): error
            + Read(): (MoxMessage, error)
            + Close()
            + IsAlive(): bool
        }
}

' ==========================================
' 5. RELATIONS (Wiring)
' ==========================================

' --- Interface Implementation (Realization) ---
Registry ..|> IRegistrar
Registry ..|> IProvider
Bus      ..|> IMessaging
UserCode ..|> IUserApp

' --- Master Composition (Ownership) ---
App *-- Registry
App *-- Server
App *-- Bus
App *-- Brain

' --- Dependency Injection (Usage) ---
Server ..> IRegistrar : writes to
Bus    ..> IProvider  : reads from
Brain  ..> IMessaging : commands
Brain  ..> IProvider  : monitors

' --- Worker Composition ---
Agent *-- Client
Agent o-- IUserCode

' --- Network Communication (The Bridge) ---
Server <..> Client : Unix Domain Socket\n(JSON + SCM_RIGHTS)

' --- Protocol Dependency ---
Server ..> MoxMessage : uses
Client ..> MoxMessage : uses
Bus    ..> MoxMessage : wraps

@enduml
